# 容器编排

## 什么是容器编排

容器编排是指容器的集群化管理和容器调度。常有的功能有启动容器，根据资源调动容器所在的位置，会跟踪和监控容器的状态，如果一个容器异常故障，编排系统会重启容器。在部署和更新容器时，如果出现问题，还可以回滚。常用的容器编排系统有Docker swarm 、Kuberbetes等。

## Docker swarm简介
Docker swarm架构图
![Docker swarm](../img/docker-swarm1.png)

### docker 节点（node）

- manager节点维持集群状态，调动任务，集群服务。manager节点采用raft一致性协议，所以建议至少的2n+1，这个集群会通过raft选举出一位leader。

- worker节点是真正执行docker容器的节点。manager节点本身也可以是worker节点，当然可以配置成不作为worker节点。worke之间的状态使用gossip分布式是一致性协议，gossip的特性是最终一致性和幂等性，相比于raft，gossip的时效性差一点，但是raft集群数（基于log的状态机复制）是有限制的。

### 任务（task）和 服务（service）

- 任务（task）可以理解为单一的docker 容器。
- 服务是一组任务的总和，

## Docker swarm使用

```bash

#docker swarm
#manager
docker swarm init -advertise-addr 192.168.99.100

#worker
docker swarm join XXXX

#分布式运用部署

#swarm 下面的overlay 网络创建
docker network create -d overlay demo #在使用后才可以在node节点可见

#mysql 注意mysql.8 不能之样子部署 https://hub.docker.com/_/mysql/ command: --default-authentication-plugin=mysql_native_password 

docker service create --name mysql --env MYSQL_ROOT_PASSWORD=root --env MYSQL_DATABASE=wordpress --network=demo --mount type=volume,source=mysql-data,destination=/var/lib/mysql mysql:5.7 
docker service create --name wordpress -p 80:80 --network=demo --replicas 3 --env WORDPRESS_DB_PASSWORD=root --env WORDPRESS_DB_HOST=mysql wordpress 

#查看service 列表
docker service ls


#查看某个服务的容器分布情况
docker service ps web

#service 无中断更新
docker service update --image=xxx:2.0 web


#service 更新端口
docker service update --public-rm 8080:80 --public-add 8088:80 web


#docker stack
docker stack deploy -c docker-compose.yml wordpress


#docer stack 更新
修改docker-compose.yaml文件

然后直接docker stack deploy -f docker-compose.yaml
```


## Kuberbetes简介


## Kuberbetes使用