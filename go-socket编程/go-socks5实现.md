# go socks5实现

## 什么是SOCKS

SOCKS是一种网络传输协议，主要用于Client端与外网Server端之间通讯的中间传递。SOCKS是"SOCKETS"的缩写，意外这一切socks都可以通过代理。
SOCKS是一种代理协议，相比于常见的HTTP代理，SOCKS的代理更加的底层，传统的HTTP代理会修改HTTP头，SOCKS则不会它只是做了数据的中转。

SOCKS的最新版本为SOCKS5。

## SOCKS5协议详解

SOCKS5的协议是基于二进制的，协议设计十分的简洁。

Client端和Server端第一次通讯的时候，Client端会想服务端发送版本认证信息，协议格式如下：
```
	+----+----------+----------+
	|VER | NMETHODS | METHODS  |
	+----+----------+----------+
	| 1  |    1     | 1 to 255 |
	+----+----------+----------+
```    
- VER是SOCKS版本，目前版本是0x05；
- NMETHODS是METHODS部分的长度；
- METHODS是Client端支持的认证方式列表，每个方法占1字节。当前的定义是：
  - 0x00 不需要认证
  - 0x01 GSSAPI
  - 0x02 用户名、密码认证
  - 0x03 - 0x7F由IANA分配（保留）
  - 0x80 - 0xFE为私人方法保留
  - 0xFF 无可接受的方法

Server端从Client端提供的方法中选择一个并通过以下消息通知Client端：

```
	+----+--------+
	|VER | METHOD |
	+----+--------+
	| 1  |   1    |
	+----+--------+
```    

- VER是SOCKS版本，目前是0x05；
- METHOD是服务端选中的方法。如果返回0xFF表示没有一个认证方法被选中，Client端需要关闭连接。

SOCKS5请求协议格式：

```
	+----+-----+-------+------+----------+----------+
	|VER | CMD |  RSV  | ATYP | DST.ADDR | DST.PORT |
	+----+-----+-------+------+----------+----------+
	| 1  |  1  | X'00' |  1   | Variable |    2     |
	+----+-----+-------+------+----------+----------+
```
- VER是SOCKS版本，目前是0x05；
- CMD是SOCK的命令码
    - 0x01表示CONNECT请求
    - 0x02表示BIND请求
    - 0x03表示UDP转发
- RSV 0x00，保留
- ATYP DST.ADDR类型
    - 0x01 IPv4地址，DST.ADDR部分4字节长度
    - 0x03 域名地址，DST.ADDR部分第一个字节为域名长度，剩余的内容为域名。
    - 0x04 IPv6地址，16个字节长度。
- DST.ADDR 目的地址
- DST.PORT 网络字节序表示的目的端口

Server端按以下格式返回给Client端：

```
	+----+-----+-------+------+----------+----------+
	|VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
	+----+-----+-------+------+----------+----------+
	| 1  |  1  | X'00' |  1   | Variable |    2     |
	+----+-----+-------+------+----------+----------+
```
- VER是SOCKS版本，目前是0x05；
- REP应答字段
    - 0x00 表示成功
    - 0x01 普通SOCKSServer端连接失败
    - 0x02 现有规则不允许连接
    - 0x03 网络不可达
    - 0x04 主机不可达
    - 0x05 连接被拒
    - 0x06 TTL超时域名地址
    - 0x07 不支持的命令
    - 0x08 不支持的地址类型
    - 0x09 - 0xFF未定义
- RSV 0x00，保留
- ATYP BND.ADDR类型
    - 0x01 IPv4地址，DST.ADDR部分4字节长度
    - 0x03 域名地址，DST.ADDR部分第一个字节为域名长度，剩余的内容为域名。
    - 0x04 IPv6地址，16个字节长度。
- BND.ADDR Server端绑定的地址
- BND.PORT 网络字节序表示的Server端绑定的端口